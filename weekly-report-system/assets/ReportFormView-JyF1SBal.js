import{d as Q,p as R,q as X,u as Z,v as Y,x as ee,c as te,o as re,a as w,b as p,e,w as t,r as a,y as oe,E as se,z as le,f as v,l as I,g as x,A as ae,F as H,k as q,t as C,B as m,C as ue,D as ne,G as de,_ as me}from"./index-DRy33ewS.js";const ie={class:"report-form-view"},ce={class:"card-header"},pe={class:"work-items-section"},_e={class:"work-items-header"},fe={key:0,class:"empty-work-items"},ke={key:1,class:"work-items-list"},we=Q({__name:"ReportFormView",setup(ye){R.extend(X);const U=ue(),$=oe(),u=Z(),_=Y(),f=Y(!1),y=Y(!1),h=Y(""),D=R().year(),V=R().isoWeek(),r=ee({summary:"",workItems:[]}),E={summary:[{required:!0,message:"请输入周报总结",trigger:"blur"},{min:10,message:"总结至少10个字符",trigger:"blur"}]},S=te(()=>u.getActiveProjects),M=()=>{r.workItems.push({projectId:"",taskDescription:"",workHours:8,workDate:R().format("YYYY-MM-DD")})},W=s=>{r.workItems.splice(s,1)},j=async()=>{if(_.value)try{if(await _.value.validate(),r.workItems.length===0){m.warning("请至少添加一个工时项");return}if(f.value=!0,y.value)u.updateReport(h.value,{summary:r.summary,status:"submitted",workItems:r.workItems})?(m.success("周报更新成功"),U.push("/report-list")):m.error("周报更新失败");else{const s=u.addReport({userId:u.currentUser?.id||"",year:D,week:V,summary:r.summary,workItems:r.workItems});s?(u.submitReport(s.id),m.success("周报提交成功"),U.push("/report-list")):m.error("周报创建失败")}}catch(s){console.error("表单验证失败:",s)}finally{f.value=!1}},F=async()=>{if(_.value)try{await _.value.validate(),f.value=!0,y.value?u.updateReport(h.value,{summary:r.summary,status:"draft",workItems:r.workItems})?m.success("草稿保存成功"):m.error("草稿保存失败"):u.addReport({userId:u.currentUser?.id||"",year:D,week:V,summary:r.summary,workItems:r.workItems})?(m.success("草稿保存成功"),U.push("/report-list")):m.error("草稿保存失败")}catch(s){console.error("表单验证失败:",s)}finally{f.value=!1}},z=()=>{r.summary="",r.workItems=[],_.value?.resetFields()},N=()=>{const s=$.query.id;if(s){const o=u.reports.find(l=>l.id===s);o&&(y.value=!0,h.value=s,r.summary=o.summary,r.workItems=o.workItems.map(l=>({projectId:l.projectId,taskDescription:l.taskDescription,workHours:l.workHours,workDate:l.workDate})))}else{const o=u.currentUser;if(o){const l=u.getCurrentWeekReport(o.id);l&&l.status==="draft"&&se.confirm(`发现${D}年第${V}周的草稿，是否继续编辑？`,"发现草稿",{confirmButtonText:"继续编辑",cancelButtonText:"新建周报",type:"info"}).then(()=>{y.value=!0,h.value=l.id,r.summary=l.summary,r.workItems=l.workItems.map(i=>({projectId:i.projectId,taskDescription:i.taskDescription,workHours:i.workHours,workDate:i.workDate}))}).catch(()=>{})}}};return re(()=>{u.initializeStore(),N(),r.workItems.length===0&&M()}),(s,o)=>{const l=a("el-tag"),i=a("el-input"),c=a("el-form-item"),B=a("el-icon"),g=a("el-button"),T=a("el-empty"),A=a("el-option"),P=a("el-select"),b=a("el-col"),G=a("el-input-number"),L=a("el-date-picker"),O=a("el-row"),J=a("el-form"),K=a("el-card");return p(),w("div",ie,[e(K,null,{header:t(()=>[v("div",ce,[o[1]||(o[1]=v("span",null,"填报周报",-1)),e(l,{type:"info"},{default:t(()=>[I(C(x(D))+"年第"+C(x(V))+"周",1)]),_:1})])]),default:t(()=>[e(J,{ref_key:"formRef",ref:_,model:r,rules:E,"label-width":"120px",onSubmit:le(j,["prevent"])},{default:t(()=>[e(c,{label:"周报总结",prop:"summary"},{default:t(()=>[e(i,{modelValue:r.summary,"onUpdate:modelValue":o[0]||(o[0]=d=>r.summary=d),type:"textarea",rows:4,placeholder:"请填写本周工作总结...",maxlength:"500","show-word-limit":""},null,8,["modelValue"])]),_:1}),e(c,{label:"工时记录"},{default:t(()=>[v("div",pe,[v("div",_e,[o[3]||(o[3]=v("span",null,"工作项目",-1)),e(g,{type:"primary",size:"small",onClick:M},{default:t(()=>[e(B,null,{default:t(()=>[e(x(ae))]),_:1}),o[2]||(o[2]=I(" 添加工时项 ",-1))]),_:1})]),r.workItems.length===0?(p(),w("div",fe,[e(T,{description:"暂无工时记录"})])):(p(),w("div",ke,[(p(!0),w(H,null,q(r.workItems,(d,k)=>(p(),w("div",{key:k,class:"work-item"},[e(O,{gutter:10},{default:t(()=>[e(b,{span:8},{default:t(()=>[e(c,{prop:`workItems.${k}.projectId`,rules:[{required:!0,message:"请选择项目",trigger:"change"}]},{default:t(()=>[e(P,{modelValue:d.projectId,"onUpdate:modelValue":n=>d.projectId=n,placeholder:"选择项目",style:{width:"100%"}},{default:t(()=>[(p(!0),w(H,null,q(S.value,n=>(p(),ne(A,{key:n.id,label:n.name,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]),_:2},1024),e(b,{span:8},{default:t(()=>[e(c,{prop:`workItems.${k}.workHours`,rules:[{required:!0,message:"请输入工时",trigger:"blur"},{type:"number",min:.5,max:24,message:"工时范围0.5-24小时",trigger:"blur"}]},{default:t(()=>[e(G,{modelValue:d.workHours,"onUpdate:modelValue":n=>d.workHours=n,min:.5,max:24,step:.5,placeholder:"工时",style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]),_:2},1024),e(b,{span:6},{default:t(()=>[e(c,{prop:`workItems.${k}.workDate`,rules:[{required:!0,message:"请选择日期",trigger:"change"}]},{default:t(()=>[e(L,{modelValue:d.workDate,"onUpdate:modelValue":n=>d.workDate=n,type:"date",placeholder:"工作日期",style:{width:"100%"},format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]),_:2},1024),e(b,{span:2},{default:t(()=>[e(g,{type:"danger",size:"small",onClick:n=>W(k)},{default:t(()=>[e(B,null,{default:t(()=>[e(x(de))]),_:1})]),_:1},8,["onClick"])]),_:2},1024)]),_:2},1024),e(c,{prop:`workItems.${k}.taskDescription`,rules:[{required:!0,message:"请输入任务描述",trigger:"blur"}]},{default:t(()=>[e(i,{modelValue:d.taskDescription,"onUpdate:modelValue":n=>d.taskDescription=n,placeholder:"请输入任务描述...",maxlength:"200","show-word-limit":""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]))),128))]))])]),_:1}),e(c,null,{default:t(()=>[e(g,{type:"primary",onClick:j,loading:f.value},{default:t(()=>[I(C(y.value?"更新周报":"保存周报"),1)]),_:1},8,["loading"]),e(g,{onClick:F,loading:f.value},{default:t(()=>[...o[4]||(o[4]=[I(" 保存草稿 ",-1)])]),_:1},8,["loading"]),e(g,{onClick:z},{default:t(()=>[...o[5]||(o[5]=[I("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})])}}}),ve=me(we,[["__scopeId","data-v-23095053"]]);export{ve as default};
